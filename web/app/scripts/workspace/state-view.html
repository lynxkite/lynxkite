<div ng-repeat="state in result.states track by $index">
  <div id="state-toolbar" class="flat-toolbar" ng-if="state.stateId">
    <button
      class="btn btn-default" id="save-as-snapshot-button"
      ng-click="snapshotNameOpen = true"
      drop-tooltip="Click to snapshot state as {{saveAsName}}"
      drop-tooltip-placement="bottom">
      <i class="glyphicon glyphicon-camera"></i>
    </button>
    <inline-input
      id="save-as-snapshot-box"
      placeholder="Snapshot name..."
      ng-init="snapshotName = getDefaultSnapshotName()"
      input="snapshotName"
      onsubmit="createSnapshot(state.stateId, input, success, error)"
      open="snapshotNameOpen"></inline-input>

    <!-- TODO: Build instrument toolbar dynamically, allow any operation. -->
    <button
      ng-hide="$last"
      class="btn btn-default"
      ng-click="clearInstrument($index)"
      drop-tooltip="Return to this state"
      drop-tooltip-placement="bottom">
      <i class="glyphicon glyphicon-remove"></i>
    </button>
    <button
      ng-show="state.kind === 'table' || state.kind === 'project'"
      ng-class="{ active: instruments[$index].operationId === 'SQL1' }"
      class="btn btn-default"
      ng-click="setInstrument($index, 'SQL1')">
      SQL
    </button>
    <button
      ng-show="state.kind === 'table'"
      ng-class="{ active: instruments[$index].operationId === 'Custom plot' }"
      class="btn btn-default"
      ng-click="setInstrument($index, 'Custom plot')">
      Plot
    </button>
    <button
      ng-show="state.kind === 'project'"
      ng-class="{ active: instruments[$index].operationId === 'Graph visualization' }"
      class="btn btn-default"
      ng-click="setInstrument($index, 'Graph visualization')">
      Visualize
    </button>
  </div>

  <!-- "box" is faked just enough to serve <visualization-parameter>. -->
  <op-editor
    ng-if="!$last"
    box="{ outputs: [{ stateId: result.states[$index + 1].stateId }] }"
    box-meta="result.metas[$index]"
    parameters="instruments[$index].parameters"
    parametric-parameters="instruments[$index].parametricParameters"></op-editor>

  <div ng-if="$last">
    <project-state-view
      state-id="state.stateId"
      ng-if="state.kind === 'project'">
    </project-state-view>
    <export-result
      state-id="state.stateId"
      ng-if="state.kind === 'exportResult'">
    </export-result>
    <table-state-view
      state-id="state.stateId"
      ng-if="state.kind === 'table'">
    </table-state-view>
    <plot-state-view
      state-id="state.stateId"
      popup-model="popupModel"
      ng-if="state.kind === 'plot'">
    </plot-state-view>
    <visualization-state-view
      state-id="state.stateId"
      popup-model="popupModel"
      ng-if="state.kind === 'visualization'">
    </visualization-state-view>
    <display-error
      class="col-sm-12"
      ng-if="state.kind === 'error'"
      caption="Failed to generate output state."
      error="state.error">
    </display-error>
    <progressbar
      ng-if="state.stateId === undefined" value="100" class="progress-striped active">
    </progressbar>
  </div>
</div>
